name: CI and Deploy (Docker Compose)

on:
  push:
    branches: ["main"]
  workflow_dispatch:


jobs:
  unit-tests:
    name: Unit Tests with Coverage
    runs-on: ubuntu-latest
    env:
      PER_PAGE: "9"
      ADMIN_USERNAME: "admin_ci"
      ADMIN_PASSWORD: "admin_ci_password"
      SECRET_KEY: "test-secret-key-for-ci"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies"
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests with coverage
        run: |
          echo "ðŸ§ª Running unit tests"
          coverage run -m pytest -v -k "not functional_tests"
          coverage xml

  functional-tests:
    name: Functional Tests (Selenium)
    runs-on: ubuntu-latest
    needs: unit-tests
    continue-on-error: true
    env:
      PER_PAGE: "9"
      ADMIN_USERNAME: "admin_ci"
      ADMIN_PASSWORD: "admin_ci_password"
      SELENIUM_HEADLESS: "1"
      SECRET_KEY: "test-secret-key-for-ci"
      DEBUG: "0"
      ALLOWED_HOSTS: "localhost,127.0.0.1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Google Chrome
        run: |
          echo "ðŸŒ Installing Google Chrome"
          wget -q -O /tmp/google-chrome-stable_current_amd64.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get update
          sudo apt-get install -y /tmp/google-chrome-stable_current_amd64.deb
          google-chrome --version

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies"
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run functional tests
        run: |
          echo "ðŸ§ª Running functional tests"
          pytest -v tests/functional_tests --liveserver=localhost:8000

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [unit-tests, functional-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          echo "ðŸ”‘ Adding host to known_hosts"
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "ðŸ“ Entering application directory"
          cd /home/ubuntu/app_repo || { echo "âŒ Directory not found"; exit 1; }

          # Update code from git
          if [ -d .git ]; then
            echo "ðŸ”„ Updating code (git pull)"
            git fetch --all && git reset --hard origin/main
          fi

          # Stop old containers
          echo "ðŸ›‘ Stopping old containers"
          docker-compose down

          # Build and start services
          echo "ðŸš€ Building and starting services"
          docker-compose build
          docker-compose up -d

          # Run migrations
          echo "ðŸ—ƒï¸  Running migrations"
          docker-compose exec -T django-web python manage.py migrate --noinput

          # Collect static files
          echo "ðŸ–¼ï¸  Collecting static files"
          docker-compose exec -T django-web python manage.py collectstatic --noinput

          # Restart Nginx
          echo "ðŸ” Restarting Nginx"
          docker-compose restart frontend-proxy || true

          # Cleanup
          echo "ðŸ§¹ Cleaning up old images"
          docker image prune -f || true

          echo "âœ… Deploy completed successfully"
          EOF

      - name: Health check
        run: |
          echo "ðŸ©º Waiting for services to be ready..."
          sleep 15
          echo "ðŸ©º Running health check"
          if [ -n "${{ secrets.APP_URL }}" ]; then
            for i in {1..5}; do
              echo "Attempt $i..."
              if curl -fL "https://${{ secrets.APP_URL }}/" || curl -fL "http://${{ secrets.APP_URL }}/"; then
                echo "Health check OK!"
                exit 0
              fi
              echo "Waiting 5 seconds before retrying..."
              sleep 5
            done
            echo "Health check failed after 5 attempts, continuing workflow."
          else
            echo "â„¹ï¸  APP_URL not set, skipping health check"
          fi

  
