events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    # ===== CONFIGURAÇÃO DE CACHE =====
    proxy_cache_path /var/cache/nginx/proxy_cache 
                     levels=1:2 
                     keys_zone=django_cache:100m 
                     max_size=5g
                     inactive=60m
                     use_temp_path=off;

    # Upstream para o Django
    upstream django_backend {
        server django-web:8000;
        keepalive 32;
    }

    # Compressão gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # ===== REDIRECT HTTP -> HTTPS =====
    server {
        client_max_body_size 50M;
        listen 80;
        server_name localhost receitas.daliabolosedoces.com.br 52.0.97.107;
        return 301 https://$host$request_uri;
    }

    # ===== SERVIDOR PRINCIPAL (HTTPS) =====
    server {
        server_name receitas.daliabolosedoces.com.br;
        listen 443 ssl http2;
        
        ssl_certificate /etc/letsencrypt/live/receitas.daliabolosedoces.com.br/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/receitas.daliabolosedoces.com.br/privkey.pem;

        # SSL otimizado
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        client_max_body_size 50M;

        # Logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # ===== ARQUIVOS ESTÁTICOS (SEM PROXY - SERVIDOS DIRETAMENTE) =====
        
        # CSS e JavaScript - cache longo
        location ~* ^/static/.*\.(css|js)$ {
            alias /static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # Imagens estáticas - cache muito longo
        location ~* ^/static/.*\.(jpg|jpeg|png|gif|ico|svg|webp|avif)$ {
            alias /static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # Fontes - cache longo
        location ~* ^/static/.*\.(woff|woff2|ttf|otf|eot)$ {
            alias /static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Access-Control-Allow-Origin *;
            access_log off;
        }

        # Outros arquivos estáticos - cache padrão
        location /static/ {
            alias /static/;
            expires 1M;
            add_header Cache-Control "public";
            access_log off;
        }

        # ===== MEDIA (UPLOADS) - CACHE MÉDIO =====
        
        # Imagens de media - cache médio (podem mudar)
        location ~* ^/media/.*\.(jpg|jpeg|png|gif|svg|webp|avif)$ {
            alias /media/;
            expires 7d;
            add_header Cache-Control "public";
            access_log off;
        }

        # Outros arquivos de media
        location /media/ {
            alias /media/;
            expires 1d;
            add_header Cache-Control "public";
        }

        # ===== DJANGO COM CACHE DE PROXY =====
        
        # Condições para BYPASS do cache
        set $skip_cache 0;

        # Não cacheia POST, PUT, DELETE, PATCH
        if ($request_method !~ ^(GET|HEAD)$) {
            set $skip_cache 1;
        }

        # Não cacheia URLs de admin, API write operations
        if ($request_uri ~* "/(admin|api/.*/(create|update|delete)|accounts|login|logout|register)") {
            set $skip_cache 1;
        }

        # Não cacheia se tiver cookies de sessão do Django
        if ($http_cookie ~* "(sessionid|csrftoken|messages)") {
            set $skip_cache 1;
        }

        # Não cacheia se tiver query string (pode ser paginação, filtros)
        # Comente esta linha se quiser cachear páginas com query strings
        if ($query_string != "") {
            set $skip_cache 1;
        }

        location / {
            # Proxy para Django
            proxy_pass http://django_backend;
            
            # Headers importantes
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Origin $http_origin;
            proxy_set_header Connection "";
            
            # HTTP/1.1 para keep-alive
            proxy_http_version 1.1;
            
            # Buffering
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # ===== CONFIGURAÇÃO DE CACHE =====
            proxy_cache django_cache;
            proxy_cache_bypass $skip_cache;
            proxy_no_cache $skip_cache;
            
            # Cache por tempo baseado no status
            proxy_cache_valid 200 10m;      # Páginas OK - 10 minutos
            proxy_cache_valid 301 302 1h;   # Redirects - 1 hora
            proxy_cache_valid 404 1m;       # 404 - 1 minuto apenas
            proxy_cache_valid any 1m;       # Outros - 1 minuto
            
            # Usa cache antigo se Django estiver com problemas
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;
            proxy_cache_lock_timeout 5s;
            
            # Respeita headers Cache-Control do Django
            proxy_cache_revalidate on;
            
            # Headers de debug (remova em produção se quiser)
            add_header X-Proxy-Cache $upstream_cache_status always;
            add_header X-Cache-Key "$scheme$request_method$host$request_uri" always;
        }

        # ===== ENDPOINT DE PURGE (OPCIONAL) =====
        # Permite limpar cache via: curl -X PURGE https://seusite.com/path
        location ~ /purge(/.*) {
            allow 127.0.0.1;      # Apenas localhost
            deny all;
            
        }
    }
}

# ============================================
# COMANDOS PARA APLICAR
# ============================================

# 1. Criar diretório de cache (rode no host, não no container)
# sudo mkdir -p /var/cache/nginx/proxy_cache
# sudo chown -R 101:101 /var/cache/nginx  # UID/GID do nginx no container

# 2. Se estiver usando Docker, adicione volume no docker-compose.yml:
# volumes:
#   - /var/cache/nginx:/var/cache/nginx

# 3. Testar configuração
# docker exec nginx-container nginx -t

# 4. Recarregar Nginx
# docker exec nginx-container nginx -s reload

# ============================================
# TESTAR O CACHE
# ============================================

# Teste 1: Primeira visita (deve ser MISS)
# curl -I https://receitas.daliabolosedoces.com.br/

# Teste 2: Segunda visita (deve ser HIT)
# curl -I https://receitas.daliabolosedoces.com.br/

# Verifique o header: X-Proxy-Cache
# - MISS = não estava em cache, buscou do Django
# - HIT = servido do cache
# - BYPASS = não tentou usar cache (admin, POST, etc)
# - EXPIRED = cache expirou, revalidou
# - UPDATING = cache sendo atualizado em background

# Limpar cache manualmente:
# sudo rm -rf /var/cache/nginx/proxy_cache/*
# docker exec nginx-container nginx -s reload