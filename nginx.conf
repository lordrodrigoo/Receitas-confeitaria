events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    # ===== CONFIGURAÇÃO DE CACHE =====
    proxy_cache_path /var/cache/nginx/proxy_cache 
                     levels=1:2 
                     keys_zone=django_cache:100m 
                     max_size=5g
                     inactive=60m
                     use_temp_path=off;

    # Upstream para o Django
    upstream django_backend {
        server django-web:8000;
        keepalive 32;
    }

    # Compressão gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # ===== REDIRECT HTTP -> HTTPS =====
    server {
        client_max_body_size 50M;
        listen 80;
        server_name localhost receitas.daliabolosedoces.com.br 52.0.97.107;
        return 301 https://$host$request_uri;
    }

    # ===== SERVIDOR PRINCIPAL (HTTPS) =====
    server {
        server_name receitas.daliabolosedoces.com.br;
        listen 443 ssl;
        http2 on;  # Sintaxe correta para versões novas do nginx
        
        ssl_certificate /etc/letsencrypt/live/receitas.daliabolosedoces.com.br/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/receitas.daliabolosedoces.com.br/privkey.pem;

        # SSL otimizado
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        client_max_body_size 50M;

        # Logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # ===== REMOVER TRAILING SLASHES DE ARQUIVOS ESTÁTICOS =====
        # Esta é a chave para resolver o problema!
        location ~ ^/(static|media)/(.+)/$ {
            return 301 $scheme://$host/$1/$2;
        }

        # ===== ARQUIVOS ESTÁTICOS (USAR ROOT, NÃO ALIAS) =====
        
        # Arquivos estáticos - servir diretamente do volume
        location /static/ {
            root /;  # Como o caminho já contém /static/, root aponta para /
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
            
            # Tenta servir o arquivo, se não existir retorna 404
            try_files $uri =404;
        }

        # ===== MEDIA (UPLOADS) =====
        location /media/ {
            root /;  # Como o caminho já contém /media/, root aponta para /
            expires 7d;
            add_header Cache-Control "public";
            access_log off;
            
            try_files $uri =404;
        }

        # ===== DJANGO COM CACHE DE PROXY =====
        
        # Condições para BYPASS do cache
        set $skip_cache 0;

        # Não cacheia POST, PUT, DELETE, PATCH
        if ($request_method !~ ^(GET|HEAD)$) {
            set $skip_cache 1;
        }

        # Não cacheia URLs de admin, API write operations
        if ($request_uri ~* "/(admin|api/.*/(create|update|delete)|accounts|login|logout|register)") {
            set $skip_cache 1;
        }

        # Não cacheia se tiver cookies de sessão do Django
        if ($http_cookie ~* "(sessionid|csrftoken|messages)") {
            set $skip_cache 1;
        }

        # Não cacheia se tiver query string
        if ($query_string != "") {
            set $skip_cache 1;
        }

        location / {
            # Proxy para Django
            proxy_pass http://django_backend;
            
            # Headers importantes
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Origin $http_origin;
            proxy_set_header Connection "";
            
            # HTTP/1.1 para keep-alive
            proxy_http_version 1.1;
            
            # Buffering
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # ===== CONFIGURAÇÃO DE CACHE =====
            proxy_cache django_cache;
            proxy_cache_bypass $skip_cache;
            proxy_no_cache $skip_cache;
            
            # Cache por tempo baseado no status
            proxy_cache_valid 200 10m;
            proxy_cache_valid 301 302 1h;
            proxy_cache_valid 404 1m;
            proxy_cache_valid any 1m;
            
            # Usa cache antigo se Django estiver com problemas
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            proxy_cache_lock on;
            proxy_cache_lock_timeout 5s;
            
            # Respeita headers Cache-Control do Django
            proxy_cache_revalidate on;
            
            # Headers de debug
            add_header X-Proxy-Cache $upstream_cache_status always;
            add_header X-Cache-Key "$scheme$request_method$host$request_uri" always;
        }
    }
}

# ============================================
# COMANDOS PARA APLICAR
# ============================================

# 1. Substituir o nginx.conf
# 2. Testar a configuração
# docker exec app_repo_frontend-proxy_1 nginx -t

# 3. Se OK, recarregar
# docker-compose restart frontend-proxy

# 4. Verificar os logs
# docker-compose logs -f frontend-proxy

# ============================================
# O QUE FOI CORRIGIDO:
# ============================================

# 1. Removido uso de 'alias' com regex (causa o bug do trailing slash)
# 2. Trocado por 'root /' que funciona corretamente
# 3. Adicionado redirect 301 para remover trailing slashes de arquivos estáticos
# 4. Simplificado: apenas 2 location blocks em vez de múltiplos com regex
# 5. Corrigido warning do http2 (sintaxe nova)
# 6. Removido proxy_cache_purge (causava erro ao iniciar)